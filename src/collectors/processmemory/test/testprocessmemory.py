#!/usr/bin/python
# coding=utf-8
################################################################################

from test import CollectorTestCase
from test import get_collector_config
from test import unittest
from mock import patch, Mock

from diamond.collector import Collector
from processmemory import ProcessMemoryCollector

################################################################################


class TestProcessMemoryCollector(CollectorTestCase):
    TEST_CONFIG = {
        'interval': 10,
        'process': {
            'postgres': {
                'exe': '^\/usr\/lib\/postgresql\/+d.+d\/bin\/postgres',
                'name': ['postgres', 'pg'],
            },
            'foo': {
                'exe': '^foobar',
            },
        }
    }

    def setUp(self):
        config = get_collector_config('ProcessMemoryCollector',
                                      self.TEST_CONFIG)

        self.collector = ProcessMemoryCollector(config, None)

    @patch.object(Collector, 'publish')
    def test(self, publish_mock):
        process_info_list = [
            {'exe': '/sbin/init',
             'name': 'init',
             'pid': 1,
             'rss': 2363392,
             'vms': 24784896},
            {'name': 'kthreadd', 'pid': 2, 'rss': 0, 'vms': 0},
            {'name': 'ksoftirqd/0', 'pid': 3, 'rss': 0, 'vms': 0},
            {'name': 'migration/0', 'pid': 6, 'rss': 0, 'vms': 0},
            {'name': 'watchdog/0', 'pid': 7, 'rss': 0, 'vms': 0},
            {'name': 'migration/1', 'pid': 8, 'rss': 0, 'vms': 0},
            {'name': 'ksoftirqd/1', 'pid': 10, 'rss': 0, 'vms': 0},
            {'name': 'watchdog/1', 'pid': 12, 'rss': 0, 'vms': 0},
            {'name': 'migration/2', 'pid': 13, 'rss': 0, 'vms': 0},
            {'name': 'ksoftirqd/2', 'pid': 15, 'rss': 0, 'vms': 0},
            {'name': 'watchdog/2', 'pid': 16, 'rss': 0, 'vms': 0},
            {'name': 'migration/3', 'pid': 17, 'rss': 0, 'vms': 0},
            {'name': 'ksoftirqd/3', 'pid': 19, 'rss': 0, 'vms': 0},
            {'name': 'watchdog/3', 'pid': 20, 'rss': 0, 'vms': 0},
            {'name': 'cpuset', 'pid': 21, 'rss': 0, 'vms': 0},
            {'name': 'khelper', 'pid': 22, 'rss': 0, 'vms': 0},
            {'name': 'kdevtmpfs', 'pid': 23, 'rss': 0, 'vms': 0},
            {'name': 'netns', 'pid': 24, 'rss': 0, 'vms': 0},
            {'name': 'sync_supers', 'pid': 25, 'rss': 0, 'vms': 0},
            {'name': 'bdi-default', 'pid': 26, 'rss': 0, 'vms': 0},
            {'name': 'kintegrityd', 'pid': 27, 'rss': 0, 'vms': 0},
            {'name': 'kblockd', 'pid': 28, 'rss': 0, 'vms': 0},
            {'name': 'ata_sff', 'pid': 29, 'rss': 0, 'vms': 0},
            {'name': 'khubd', 'pid': 30, 'rss': 0, 'vms': 0},
            {'name': 'md', 'pid': 31, 'rss': 0, 'vms': 0},
            {'name': 'khungtaskd', 'pid': 33, 'rss': 0, 'vms': 0},
            {'name': 'kswapd0', 'pid': 34, 'rss': 0, 'vms': 0},
            {'name': 'ksmd', 'pid': 35, 'rss': 0, 'vms': 0},
            {'name': 'khugepaged', 'pid': 36, 'rss': 0, 'vms': 0},
            {'name': 'fsnotify_mark', 'pid': 37, 'rss': 0, 'vms': 0},
            {'name': 'ecryptfs-kthrea', 'pid': 38, 'rss': 0, 'vms': 0},
            {'name': 'crypto', 'pid': 39, 'rss': 0, 'vms': 0},
            {'name': 'kthrotld', 'pid': 47, 'rss': 0, 'vms': 0},
            {'name': 'scsi_eh_0', 'pid': 50, 'rss': 0, 'vms': 0},
            {'name': 'scsi_eh_1', 'pid': 51, 'rss': 0, 'vms': 0},
            {'name': 'scsi_eh_2', 'pid': 52, 'rss': 0, 'vms': 0},
            {'name': 'scsi_eh_3', 'pid': 53, 'rss': 0, 'vms': 0},
            {'name': 'scsi_eh_4', 'pid': 54, 'rss': 0, 'vms': 0},
            {'name': 'scsi_eh_5', 'pid': 55, 'rss': 0, 'vms': 0},
            {'name': 'devfreq_wq', 'pid': 81, 'rss': 0, 'vms': 0},
            {'name': 'jbd2/sda5-8', 'pid': 267, 'rss': 0, 'vms': 0},
            {'name': 'ext4-dio-unwrit', 'pid': 268, 'rss': 0, 'vms': 0},
            {'name': 'upstart-udev-bridge', 'pid': 318, 'rss': 655360,
             'vms': 17526784},
            {'name': 'udevd', 'pid': 325, 'rss': 2134016, 'vms': 22605824},
            {'name': 'kpsmoused', 'pid': 626, 'rss': 0, 'vms': 0},
            {'name': 'upstart-socket-bridge', 'pid': 726, 'rss': 401408,
             'vms': 15429632},
            {'name': 'irq/51-mei', 'pid': 732, 'rss': 0, 'vms': 0},
            {'name': 'cfg80211', 'pid': 741, 'rss': 0, 'vms': 0},
            {'name': 'scsi_eh_6', 'pid': 806, 'rss': 0, 'vms': 0},
            {'name': 'rts5139-control', 'pid': 807, 'rss': 0, 'vms': 0},
            {'name': 'rts5139-polling', 'pid': 809, 'rss': 0, 'vms': 0},
            {'name': 'hd-audio0', 'pid': 933, 'rss': 0, 'vms': 0},
            {'name': 'flush-8:0', 'pid': 944, 'rss': 0, 'vms': 0},
            {'exe': '/usr/sbin/sshd',
             'name': 'sshd',
             'pid': 990,
             'rss': 2834432,
             'vms': 50892800},
            {'name': 'smbd', 'pid': 995, 'rss': 4956160, 'vms': 96010240},
            {'name': 'rsyslogd', 'pid': 1005, 'rss': 1744896,
             'vms': 121122816},
            {'name': 'dbus-daemon', 'pid': 1021, 'rss': 2465792,
             'vms': 25829376},
            {'exe': '/usr/sbin/modem-manager',
             'name': 'modem-manager',
             'pid': 1030,
             'rss': 3264512,
             'vms': 82780160},
            {'name': 'udevd', 'pid': 1045, 'rss': 1626112, 'vms': 22597632},
            {'exe': '/usr/sbin/cupsd',
             'name': 'cupsd',
             'pid': 1048,
             'rss': 3485696,
             'vms': 72683520},
            {'name': 'avahi-daemon: running [Roller.local]',
             'pid': 1051,
             'rss': 1859584,
             'vms': 33050624},
            {'name': 'avahi-daemon: chroot helper',
             'pid': 1053,
             'rss': 479232,
             'vms': 32923648},
            {'name': 'NetworkManager', 'pid': 1057, 'rss': 5619712,
             'vms': 168550400},
            {'exe': '/usr/lib/x86_64-linux-gnu/colord/colord',
             'name': 'colord',
             'pid': 1062,
             'rss': 11972608,
             'vms': 376303616},
            {'name': 'smbd', 'pid': 1063, 'rss': 1503232, 'vms': 96010240},
            {'exe': '/usr/lib/policykit-1/polkitd',
             'name': 'polkitd',
             'pid': 1066,
             'rss': 4227072,
             'vms': 135073792},
            {'exe': '/sbin/wpa_supplicant',
             'name': 'wpa_supplicant',
             'pid': 1076,
             'rss': 2887680,
             'vms': 31707136},
            {'name': 'nmbd', 'pid': 1235, 'rss': 1925120, 'vms': 65306624},
            {'exe': '/sbin/getty',
             'name': 'getty',
             'pid': 1347,
             'rss': 659456,
             'vms': 4296704},
            {'exe': '/sbin/getty',
             'name': 'getty',
             'pid': 1351,
             'rss': 659456,
             'vms': 4296704},
            {'exe': '/usr/sbin/bumblebeed',
             'name': 'bumblebeed',
             'pid': 1355,
             'rss': 1748992,
             'vms': 36835328},
            {'exe': '/sbin/getty',
             'name': 'getty',
             'pid': 1375,
             'rss': 655360,
             'vms': 4296704},
            {'exe': '/sbin/getty',
             'name': 'getty',
             'pid': 1376,
             'rss': 651264,
             'vms': 4296704},
            {'exe': '/sbin/getty',
             'name': 'getty',
             'pid': 1378,
             'rss': 655360,
             'vms': 4296704},
            {'name': 'acpid', 'pid': 1384, 'rss': 860160, 'vms': 4448256},
            {'name': 'lightdm', 'pid': 1385, 'rss': 4198400, 'vms': 187936768},
            {'name': 'cron', 'pid': 1388, 'rss': 1093632, 'vms': 19447808},
            {'name': 'atd', 'pid': 1389, 'rss': 385024, 'vms': 17195008},
            {'exe': '/usr/sbin/irqbalance',
             'name': 'irqbalance',
             'pid': 1397,
             'rss': 667648,
             'vms': 16244736},
            {'exe': '/usr/bin/X',
             'name': 'Xorg',
             'pid': 1416,
             'rss': 34426880,
             'vms': 224362496},
            {'name': 'kvm-irqfd-clean', 'pid': 1418, 'rss': 0, 'vms': 0},
            {'name': 'udevd', 'pid': 1419, 'rss': 1548288, 'vms': 22601728},
            {'exe': '/usr/lib/postgresql/9.1/bin/postgres',
             'name': 'postgres',
             'pid': 1427,
             'rss': 9875456,
             'vms': 106852352},
            {'exe': '/usr/lib/accountsservice/accounts-daemon',
             'name': 'accounts-daemon',
             'pid': 1437,
             'rss': 3792896,
             'vms': 126386176},
            {'name': 'postgres: writer process   ',
             'pid': 1445,
             'rss': 1753088,
             'vms': 106835968},
            {'name': 'postgres: wal writer process   ',
             'pid': 1446,
             'rss': 1503232,
             'vms': 106835968},
            {'name': 'postgres: autovacuum launcher process   ',
             'pid': 1447,
             'rss': 3989504,
             'vms': 109023232},
            {'name': 'postgres: stats collector process   ',
             'pid': 1448,
             'rss': 2400256,
             'vms': 75829248},
            {'exe': '/usr/sbin/console-kit-daemon',
             'name': 'console-kit-daemon',
             'pid': 1457,
             'rss': 3989504,
             'vms': 130379776},
            {'exe': '/usr/lib/upower/upowerd',
             'name': 'upowerd',
             'pid': 1593,
             'rss': 4554752,
             'vms': 157356032},
            {'exe': '/usr/bin/memcached',
             'name': 'memcached',
             'pid': 1597,
             'rss': 1245184,
             'vms': 196603904},
            {'name': 'nginx', 'pid': 1626, 'rss': 1232896, 'vms': 75329536},
            {'name': 'nginx: worker process',
             'pid': 1627,
             'rss': 1658880,
             'vms': 75677696},
            {'name': 'nginx: worker process',
             'pid': 1628,
             'rss': 1925120,
             'vms': 75677696},
            {'name': 'nginx: worker process',
             'pid': 1629,
             'rss': 1925120,
             'vms': 75677696},
            {'name': 'nginx: worker process',
             'pid': 1630,
             'rss': 1921024,
             'vms': 75677696},
            {'exe': '/usr/sbin/tor',
             'name': 'tor',
             'pid': 1704,
             'rss': 20090880,
             'vms': 52318208},
            {'exe': '/usr/lib/rtkit/rtkit-daemon',
             'name': 'rtkit-daemon',
             'pid': 1728,
             'rss': 1388544,
             'vms': 105697280},
            {'exe': '/usr/sbin/bluetoothd',
             'name': 'bluetoothd',
             'pid': 1744,
             'rss': 1687552,
             'vms': 23605248},
            {'name': 'krfcommd', 'pid': 1761, 'rss': 0, 'vms': 0},
            {'exe': '/usr/bin/ssh-agent',
             'name': 'ssh-agent',
             'pid': 2398,
             'rss': 282624,
             'vms': 12574720},
            {'exe': '/usr/bin/dbus-launch',
             'name': 'dbus-launch',
             'pid': 2401,
             'rss': 565248,
             'vms': 27086848},
            {'exe': '/bin/dbus-daemon',
             'name': 'dbus-daemon',
             'pid': 2402,
             'rss': 2641920,
             'vms': 27377664},
            {'exe': '/usr/lib/gvfs/gvfsd',
             'name': 'gvfsd',
             'pid': 2404,
             'rss': 2605056,
             'vms': 56569856},
            {'exe': '/usr/lib/gvfs/gvfs-fuse-daemon',
             'name': 'gvfs-fuse-daemon',
             'pid': 2409,
             'rss': 2555904,
             'vms': 80789504},
            {'exe': '/usr/lib/libgconf2-4/gconfd-2',
             'name': 'gconfd-2',
             'pid': 2432,
             'rss': 3960832,
             'vms': 62443520},
            {'exe': '/usr/lib/gnome-settings-daemon/gsd-printer',
             'name': 'gsd-printer',
             'pid': 2434,
             'rss': 4767744,
             'vms': 244137984},
            {'exe': '/usr/bin/metacity',
             'name': 'metacity',
             'pid': 2438,
             'rss': 17031168,
             'vms': 423026688},
            {'exe': '/usr/bin/gnome-screensaver',
             'name': 'gnome-screensaver',
             'pid': 2440,
             'rss': 8671232,
             'vms': 248119296},
            {'exe': '/usr/bin/gnome-panel',
             'name': 'gnome-panel',
             'pid': 2449,
             'rss': 28717056,
             'vms': 511975424},
            {'exe': '/usr/lib/d-conf/dconf-service',
             'name': 'dconf-service',
             'pid': 2458,
             'rss': 3125248,
             'vms': 136343552},
            {'exe': '/usr/bin/gnome-sound-applet',
             'name': 'gnome-sound-applet',
             'pid': 2462,
             'rss': 14499840,
             'vms': 408084480},
            {'exe': '/usr/bin/nm-applet',
             'name': 'nm-applet',
             'pid': 2463,
             'rss': 14098432,
             'vms': 434642944},
            {
                'exe': '/usr/lib/gnome-settings-daemon/gnome-fallback-mount'
                       '-helper',
                'name': 'gnome-fallback-mount-helper',
                'pid': 2464,
                'rss': 8183808,
                'vms': 251990016},
            {
                'exe': '/usr/lib/policykit-1-gnome/polkit-gnome-authentication'
                       '-agent-1',
                'name': 'polkit-gnome-authentication-agent-1',
                'pid': 2471,
                'rss': 7315456,
                'vms': 230354944},
            {'exe': '/usr/bin/python2.7',
             'name': 'mintupdate-laun',
             'pid': 2474,
             'rss': 5074944,
             'vms': 34992128},
            {'exe': '/usr/lib/notify-osd/notify-osd',
             'name': 'notify-osd',
             'pid': 2479,
             'rss': 14626816,
             'vms': 335065088},
            {'exe': '/bin/dash',
             'name': 'sh',
             'pid': 2481,
             'rss': 593920,
             'vms': 4382720},
            {'exe': '/usr/bin/nautilus',
             'name': 'nautilus',
             'pid': 2483,
             'rss': 38690816,
             'vms': 683737088},
            {'exe': '/usr/bin/python2.7',
             'name': 'mintUpdate',
             'pid': 2484,
             'rss': 31608832,
             'vms': 393109504},
            {'exe': '/usr/lib/gvfs/gvfs-gdu-volume-monitor',
             'name': 'gvfs-gdu-volume-monitor',
             'pid': 2489,
             'rss': 4243456,
             'vms': 91836416},
            {'exe': '/usr/lib/udisks/udisks-daemon',
             'name': 'udisks-daemon',
             'pid': 2492,
             'rss': 4259840,
             'vms': 141549568},
            {'name': 'udisks-daemon', 'pid': 2494, 'rss': 843776,
             'vms': 48562176},
            {'exe': '/usr/bin/bluetooth-applet',
             'name': 'bluetooth-applet',
             'pid': 2499,
             'rss': 11354112,
             'vms': 329478144},
            {'exe': '/home/lacrymology/.dropbox-dist/dropbox',
             'name': 'dropbox',
             'pid': 2500,
             'rss': 57237504,
             'vms': 623648768},
            {'exe': '/usr/lib/gvfs/gvfs-gphoto2-volume-monitor',
             'name': 'gvfs-gphoto2-volume-monitor',
             'pid': 2528,
             'rss': 2625536,
             'vms': 64229376},
            {'exe': '/usr/lib/gvfs/gvfs-afc-volume-monitor',
             'name': 'gvfs-afc-volume-monitor',
             'pid': 2530,
             'rss': 2711552,
             'vms': 78561280},
            {'exe': '/usr/lib/gnome-settings-daemon/gnome-settings-daemon',
             'name': 'gnome-settings-daemon',
             'pid': 2532,
             'rss': 20512768,
             'vms': 598499328},
            {'exe': '/usr/lib/gnome-settings-daemon/gsd-printer',
             'name': 'gsd-printer',
             'pid': 2538,
             'rss': 4775936,
             'vms': 244137984},
            {'exe': '/usr/bin/syndaemon',
             'name': 'syndaemon',
             'pid': 2548,
             'rss': 966656,
             'vms': 20561920},
            {'exe': '/usr/lib/gvfs/gvfsd-trash',
             'name': 'gvfsd-trash',
             'pid': 2578,
             'rss': 3465216,
             'vms': 61358080},
            {'exe': '/usr/lib/gnome-disk-utility/gdu-notification-daemon',
             'name': 'gdu-notification-daemon',
             'pid': 2591,
             'rss': 8572928,
             'vms': 184213504},
            {'exe': '/usr/lib/gvfs/gvfsd-burn',
             'name': 'gvfsd-burn',
             'pid': 2594,
             'rss': 2723840,
             'vms': 56737792},
            {'exe': '/usr/lib/gvfs/gvfsd-metadata',
             'name': 'gvfsd-metadata',
             'pid': 2659,
             'rss': 2506752,
             'vms': 50331648},
            {'exe': '/usr/bin/pidgin',
             'name': 'pidgin',
             'pid': 2680,
             'rss': 55713792,
             'vms': 551927808},
            {'exe': '/usr/bin/zeitgeist-datahub',
             'name': 'zeitgeist-datahub',
             'pid': 2683,
             'rss': 6221824,
             'vms': 228016128},
            {'exe': '/usr/bin/python2.7',
             'name': 'zeitgeist-daemo',
             'pid': 2689,
             'rss': 20152320,
             'vms': 211697664},
            {'exe': '/bin/cat',
             'name': 'cat',
             'pid': 2711,
             'rss': 598016,
             'vms': 12513280},
            {'exe': '/usr/lib/firefox/firefox',
             'name': 'firefox',
             'pid': 2714,
             'rss': 621666304,
             'vms': 1612206080},
            {'exe': '/usr/lib/at-spi2-core/at-spi-bus-launcher',
             'name': 'at-spi-bus-launcher',
             'pid': 2745,
             'rss': 3166208,
             'vms': 148209664},
            {'exe': '/usr/bin/gnome-terminal',
             'name': 'gnome-terminal',
             'pid': 2769,
             'rss': 20725760,
             'vms': 370888704},
            {'name': 'gnome-pty-helper', 'pid': 2773, 'rss': 880640,
             'vms': 15024128},
            {'exe': '/bin/bash',
             'name': 'bash',
             'pid': 2774,
             'rss': 10584064,
             'vms': 37081088},
            {'exe': '/usr/bin/python2.7',
             'name': 'applet.py',
             'pid': 2825,
             'rss': 24137728,
             'vms': 258322432},
            {'exe': '/usr/lib/firefox/plugin-container',
             'name': 'plugin-container',
             'pid': 2917,
             'rss': 53309440,
             'vms': 489598976},
            {'exe': '/usr/lib/deja-dup/deja-dup/deja-dup-monitor',
             'name': 'deja-dup-monitor',
             'pid': 2937,
             'rss': 4079616,
             'vms': 163778560},
            {'exe': '/bin/dash',
             'name': 'pycharm.sh',
             'pid': 3121,
             'rss': 671744,
             'vms': 4382720},
            {'exe': '/usr/lib/jvm/java-6-sun-1.6.0.26/jre/bin/java',
             'name': 'java',
             'pid': 3167,
             'rss': 1199493120,
             'vms': 2191745024},
            {
                'exe': '/home/lacrymology/.local/pycharm-121'
                       '.369/bin/fsnotifier64',
                'name': 'fsnotifier64',
                'pid': 3202,
                'rss': 1294336,
                'vms': 4796416},
            {'exe': '/usr/lib/chromium-browser/chromium-browser',
             'name': 'chromium-browser --disable-new-tab-first-run '
                     '--enable-user-scripts',
             'pid': 3288,
             'rss': 153567232,
             'vms': 716951552},
            {'exe': '/usr/lib/chromium-browser/chromium-browser',
             'name': 'chromium-browser --disable-new-tab-first-run '
                     '--enable-user-scripts',
             'pid': 3290,
             'rss': 6561792,
             'vms': 254750720},
            {'exe': '/usr/lib/chromium-browser/chromium-browser-sandbox',
             'name': 'chromium-browser-sandbox',
             'pid': 3292,
             'rss': 303104,
             'vms': 6500352},
            {'name': 'chromium-browser --type=zygote',
             'pid': 3293,
             'rss': 16158720,
             'vms': 278032384},
            {'name': 'chromium-browse', 'pid': 3294, 'rss': 0, 'vms': 0},
            {'name': 'chromium-browse', 'pid': 3331, 'rss': 23306240,
             'vms': 869289984},
            {'name': 'chromium-browse', 'pid': 3341, 'rss': 22339584,
             'vms': 868241408},
            {'name': 'chromium-browse', 'pid': 3348, 'rss': 42029056,
             'vms': 886816768},
            {'name': 'chromium-browse', 'pid': 3352, 'rss': 33841152,
             'vms': 877797376},
            {'name': 'chromium-browse', 'pid': 3360, 'rss': 37695488,
             'vms': 880758784},
            {'name': 'chromium-browse', 'pid': 3366, 'rss': 30363648,
             'vms': 874467328}
        ]

        class ProcessMock:
            def __init__(self, pid, name, rss, vms, exe=None):
                self.pid = pid
                self.name = name
                self.rss = rss
                self.vms = vms
                if exe is not None:
                    self.exe = exe
            def get_memory_info(self):
                class MemInfo:
                    def __init__(self, rss, vms):
                        self.rss = rss
                        self.vms = vms
                return MemInfo(self.rss, self.vms)
        process_iter_mock = (ProcessMock(
            pid=x['pid'],
            name=x['name'],
            rss=x['rss'],
            vms=x['vms'],
            exe=x['exe']) if 'exe' in x else ProcessMock(pid=x['pid'],
                                                         name=x['name'],
                                                         rss=x['rss'],
                                                         vms=x['vms'],
                                                         exe='')
            for x in process_info_list)

        with patch('psutil.process_iter', return_value=process_iter_mock):
            self.collector.collect()

        self.assertPublished(publish_mock, 'postgres.rss',
                             9875456+1753088+1503232+3989504+2400256)
        self.assertPublished(publish_mock, 'postgres.vms',
                             106852352+106835968+106835968+109023232+
                             75829248)
        self.assertPublished(publish_mock, 'foo.rss', 0)
        self.assertPublished(publish_mock, 'foo.vms', 0)

################################################################################
if __name__ == "__main__":
    unittest.main()
